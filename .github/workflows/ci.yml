name: CI

on:
  push:
    branches: [main, develop, release/**]
  pull_request:
    branches: [main, develop]

# Supabase env vars are needed at build time (NEXT_PUBLIC_* are embedded).
# These are injected from GitHub Secrets into every job.
env:
  NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
  NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

jobs:
  # ─── Job 1: Quality Gate ─────────────────────────────────────────────────────
  # Lint → typecheck → build.
  # Uploads the .next build as an artifact so downstream jobs skip rebuilding.
  quality:
    name: Quality Gate (lint · typecheck · build)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Validate vercel.json (if present)
        run: node scripts/validate-vercel-json.mjs

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm lint

      - name: Type check
        run: pnpm typecheck

      - name: Build
        run: pnpm build

      # Share the build artifact with the E2E job to avoid a second build
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-build
          path: .next
          retention-days: 1

  # ─── Job 2: Unit Tests ───────────────────────────────────────────────────────
  # Runs in parallel with E2E after quality passes.
  # Unit tests are pure logic — no browser, no server.
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run unit tests with coverage
        run: pnpm test:coverage

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

  # ─── Job 3: E2E Smoke Tests ──────────────────────────────────────────────────
  # Runs only on main / release branches (not on every PR, to keep CI fast).
  # Downloads the pre-built .next artifact from quality job — no second build.
  # playwright.config.ts uses `pnpm start` in CI (not `pnpm dev`).
  e2e:
    name: E2E Smoke Tests
    runs-on: ubuntu-latest
    needs: quality
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Restore the build from the quality job — skip expensive rebuild
      - name: Download build artifact
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: nextjs-build
          path: .next

      # If artifact download fails (or .next is missing), fall back to building here.
      # This makes the pipeline robust across artifact quirks while still benefiting
      # from the artifact fast-path when available.
      - name: Ensure Next.js build exists
        shell: bash
        run: |
          if [ ! -f ".next/BUILD_ID" ]; then
            echo "No .next build found from artifact; running pnpm build..."
            pnpm build
          else
            echo "Found .next build from artifact."
          fi

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium

      - name: Run E2E smoke tests
        run: pnpm test:e2e
        timeout-minutes: 10

      - name: Upload Playwright report on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7
